openapi: 3.1.0
info:
  title: CRM API
  version: 1.0.0
  description: |
    REST API for a Pipedrive-like CRM frontend.
servers:
  - url: /api/v1
security:
  - bearerAuth: []
paths:
  /auth/login:
    post:
      summary: Authenticate user and issue tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
            example:
              email: rep@example.com
              password: "Secret123!"
      responses:
        "200":
          description: Tokens issued
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthTokens"
              example:
                access_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                refresh_token: "c9f7f59b-0f3d-4d4a-bc38-9a0d1dc44baf"
                token_type: "Bearer"
                expires_in: 3600
        "401":
          $ref: "#/components/responses/Unauthorized"
  /auth/refresh:
    post:
      summary: Refresh access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refresh_token]
              properties:
                refresh_token:
                  type: string
            example:
              refresh_token: "c9f7f59b-0f3d-4d4a-bc38-9a0d1dc44baf"
      responses:
        "200":
          description: New access token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthTokens"
        "401":
          $ref: "#/components/responses/Unauthorized"
  /users:
    get:
      summary: List users
      parameters:
        - $ref: "#/components/parameters/Cursor"
        - $ref: "#/components/parameters/Limit"
      responses:
        "200":
          description: Users list
          headers:
            X-RateLimit-Limit:
              $ref: "#/components/headers/RateLimitLimit"
            X-RateLimit-Remaining:
              $ref: "#/components/headers/RateLimitRemaining"
            X-RateLimit-Reset:
              $ref: "#/components/headers/RateLimitReset"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginatedUsers"
    post:
      summary: Create user
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserCreate"
      responses:
        "201":
          description: Created user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          $ref: "#/components/responses/BadRequest"
  /users/{user_id}:
    parameters:
      - $ref: "#/components/parameters/UserId"
    get:
      summary: Get user
      responses:
        "200":
          description: User
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "404":
          $ref: "#/components/responses/NotFound"
    patch:
      summary: Update user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserUpdate"
      responses:
        "200":
          description: Updated user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "409":
          $ref: "#/components/responses/Conflict"
    delete:
      summary: Soft delete user
      responses:
        "204":
          description: Deleted
  /pipelines:
    get:
      summary: List pipelines
      parameters:
        - $ref: "#/components/parameters/Cursor"
        - $ref: "#/components/parameters/Limit"
      responses:
        "200":
          description: Pipelines list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginatedPipelines"
    post:
      summary: Create pipeline
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PipelineCreate"
      responses:
        "201":
          description: Created pipeline
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Pipeline"
  /pipelines/{pipeline_id}:
    parameters:
      - $ref: "#/components/parameters/PipelineId"
    get:
      summary: Get pipeline
      responses:
        "200":
          description: Pipeline
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Pipeline"
        "404":
          $ref: "#/components/responses/NotFound"
    patch:
      summary: Update pipeline
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PipelineUpdate"
      responses:
        "200":
          description: Updated pipeline
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Pipeline"
    delete:
      summary: Soft delete pipeline
      responses:
        "204":
          description: Deleted
  /pipelines/{pipeline_id}/stages:
    parameters:
      - $ref: "#/components/parameters/PipelineId"
    get:
      summary: List stages for pipeline
      responses:
        "200":
          description: Stages
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StagesResponse"
    post:
      summary: Create stage in pipeline
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StageCreate"
      responses:
        "201":
          description: Created stage
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Stage"
  /stages/{stage_id}:
    parameters:
      - $ref: "#/components/parameters/StageId"
    get:
      summary: Get stage
      responses:
        "200":
          description: Stage
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Stage"
    patch:
      summary: Update stage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StageUpdate"
      responses:
        "200":
          description: Updated stage
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Stage"
    delete:
      summary: Soft delete stage
      responses:
        "204":
          description: Deleted
  /pipelines/{pipeline_id}/kanban:
    get:
      summary: Fetch pipeline with stages and deal summaries
      parameters:
        - $ref: "#/components/parameters/PipelineId"
        - $ref: "#/components/parameters/StageLimit"
        - $ref: "#/components/parameters/StageCursor"
      responses:
        "200":
          description: Kanban view
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PipelineKanban"
  /deals:
    get:
      summary: List deals with filters
      description: |
        Example request: `/api/v1/deals?stage_id=stage_negotiation&owner_id=user_02&status=open&value_min=5000&updated_from=2024-01-01T00:00:00Z&sort=updated_at:desc`
      parameters:
        - $ref: "#/components/parameters/Cursor"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/DealFilterStage"
        - $ref: "#/components/parameters/DealFilterOwner"
        - $ref: "#/components/parameters/DealFilterLabel"
        - $ref: "#/components/parameters/DealFilterStatus"
        - $ref: "#/components/parameters/DealFilterValueMin"
        - $ref: "#/components/parameters/DealFilterValueMax"
        - $ref: "#/components/parameters/DealFilterUpdatedFrom"
        - $ref: "#/components/parameters/DealFilterUpdatedTo"
        - $ref: "#/components/parameters/DealFilterNextActivityFrom"
        - $ref: "#/components/parameters/DealFilterNextActivityTo"
        - $ref: "#/components/parameters/Sort"
      responses:
        "200":
          description: Deals list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginatedDeals"
              example:
                data:
                  - id: "deal_01"
                    title: "Enterprise Upgrade"
                    value:
                      amount: 125000
                      currency: "USD"
                    status: "open"
                    stage_id: "stage_qualified"
                    owner_id: "user_01"
                    organization_id: "org_01"
                    contact_id: "contact_01"
                    priority: "high"
                    labels: ["enterprise", "renewal"]
                    next_activity:
                      due_at: "2024-02-10T15:00:00Z"
                      type: "call"
                    updated_at: "2024-02-01T10:15:00Z"
                next_cursor: "eyJpZCI6ImRlYWxfMDEifQ=="
                total_count: 141
    post:
      summary: Create deal
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DealCreate"
            example:
              title: "ACME Renewal"
              value:
                amount: 75000
                currency: "USD"
              pipeline_id: "pipeline_default"
              stage_id: "stage_prospect"
              organization_id: "org_01"
              contact_id: "contact_01"
              owner_id: "user_02"
              priority: "medium"
              labels: ["renewal"]
      responses:
        "201":
          description: Created deal
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Deal"
        "400":
          $ref: "#/components/responses/BadRequest"
  /deals/{deal_id}:
    parameters:
      - $ref: "#/components/parameters/DealId"
    get:
      summary: Get deal
      responses:
        "200":
          description: Deal
          headers:
            ETag:
              $ref: "#/components/headers/ETag"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Deal"
    patch:
      summary: Update deal
      parameters:
        - $ref: "#/components/parameters/IfMatch"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DealUpdate"
      responses:
        "200":
          description: Updated deal
          headers:
            ETag:
              $ref: "#/components/headers/ETag"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Deal"
        "409":
          $ref: "#/components/responses/Conflict"
    delete:
      summary: Soft delete deal
      responses:
        "204":
          description: Deleted
  /deals/{deal_id}/move:
    parameters:
      - $ref: "#/components/parameters/DealId"
    post:
      summary: Move deal to another stage
      parameters:
        - $ref: "#/components/parameters/IfMatch"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DealMove"
            example:
              to_stage_id: "stage_negotiation"
              position: 3
      responses:
        "200":
          description: Moved deal
          headers:
            ETag:
              $ref: "#/components/headers/ETag"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Deal"
        "409":
          $ref: "#/components/responses/Conflict"
  /deals/bulk:
    post:
      summary: Bulk update or move deals
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DealBulkUpdate"
      responses:
        "200":
          description: Bulk update result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BulkResult"
  /contacts:
    get:
      summary: List contacts
      parameters:
        - $ref: "#/components/parameters/Cursor"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Sort"
      responses:
        "200":
          description: Contacts list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginatedContacts"
    post:
      summary: Create contact
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ContactCreate"
      responses:
        "201":
          description: Created contact
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Contact"
  /contacts/{contact_id}:
    parameters:
      - $ref: "#/components/parameters/ContactId"
    get:
      summary: Get contact
      responses:
        "200":
          description: Contact
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Contact"
    patch:
      summary: Update contact
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ContactUpdate"
      responses:
        "200":
          description: Updated contact
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Contact"
    delete:
      summary: Soft delete contact
      responses:
        "204":
          description: Deleted
  /organizations:
    get:
      summary: List organizations
      parameters:
        - $ref: "#/components/parameters/Cursor"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Sort"
      responses:
        "200":
          description: Organizations list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginatedOrganizations"
    post:
      summary: Create organization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OrganizationCreate"
      responses:
        "201":
          description: Created organization
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Organization"
  /organizations/{organization_id}:
    parameters:
      - $ref: "#/components/parameters/OrganizationId"
    get:
      summary: Get organization
      responses:
        "200":
          description: Organization
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Organization"
    patch:
      summary: Update organization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OrganizationUpdate"
      responses:
        "200":
          description: Updated organization
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Organization"
    delete:
      summary: Soft delete organization
      responses:
        "204":
          description: Deleted
  /activities:
    get:
      summary: List activities
      parameters:
        - $ref: "#/components/parameters/Cursor"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Sort"
      responses:
        "200":
          description: Activities list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginatedActivities"
    post:
      summary: Add activity
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ActivityCreate"
            example:
              deal_id: "deal_01"
              contact_id: "contact_01"
              type: "meeting"
              subject: "Q2 roadmap review"
              due_at: "2024-02-12T14:00:00Z"
              owner_id: "user_02"
      responses:
        "201":
          description: Created activity
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Activity"
  /activities/{activity_id}:
    parameters:
      - $ref: "#/components/parameters/ActivityId"
    get:
      summary: Get activity
      responses:
        "200":
          description: Activity
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Activity"
    patch:
      summary: Update activity
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ActivityUpdate"
      responses:
        "200":
          description: Updated activity
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Activity"
    delete:
      summary: Soft delete activity
      responses:
        "204":
          description: Deleted
  /notes:
    get:
      summary: List notes
      parameters:
        - $ref: "#/components/parameters/Cursor"
        - $ref: "#/components/parameters/Limit"
      responses:
        "200":
          description: Notes list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginatedNotes"
    post:
      summary: Add note
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NoteCreate"
            example:
              deal_id: "deal_01"
              body: "Customer asked for revised timeline and pricing."
              created_by: "user_02"
      responses:
        "201":
          description: Created note
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Note"
  /notes/{note_id}:
    parameters:
      - $ref: "#/components/parameters/NoteId"
    get:
      summary: Get note
      responses:
        "200":
          description: Note
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Note"
    patch:
      summary: Update note
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NoteUpdate"
      responses:
        "200":
          description: Updated note
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Note"
    delete:
      summary: Soft delete note
      responses:
        "204":
          description: Deleted
  /files:
    get:
      summary: List files
      parameters:
        - $ref: "#/components/parameters/Cursor"
        - $ref: "#/components/parameters/Limit"
      responses:
        "200":
          description: Files list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginatedFiles"
    post:
      summary: Upload file (multipart)
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file, deal_id]
              properties:
                file:
                  type: string
                  format: binary
                deal_id:
                  type: string
                note:
                  type: string
            examples:
              uploadFile:
                summary: Upload file to a deal
                value:
                  deal_id: "deal_01"
                  note: "Signed contract"
      responses:
        "201":
          description: Created file
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/File"
    put:
      summary: Initialize pre-signed upload
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FileUploadInit"
            example:
              deal_id: "deal_01"
              file_name: "proposal.pdf"
              content_type: "application/pdf"
              size_bytes: 482331
      responses:
        "200":
          description: Pre-signed upload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FileUploadInitResponse"
  /files/{file_id}:
    parameters:
      - $ref: "#/components/parameters/FileId"
    get:
      summary: Get file metadata
      responses:
        "200":
          description: File metadata
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/File"
    delete:
      summary: Soft delete file
      responses:
        "204":
          description: Deleted
  /files/{file_id}/download:
    parameters:
      - $ref: "#/components/parameters/FileId"
    get:
      summary: Get download URL
      responses:
        "200":
          description: Download URL
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FileDownload"
  /search:
    get:
      summary: Global search across deals, contacts, organizations
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
        - $ref: "#/components/parameters/Cursor"
        - $ref: "#/components/parameters/Limit"
      responses:
        "200":
          description: Search results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SearchResults"
  /reports/funnel:
    get:
      summary: Funnel stats by stage
      parameters:
        - $ref: "#/components/parameters/ReportFrom"
        - $ref: "#/components/parameters/ReportTo"
        - $ref: "#/components/parameters/ReportGroupBy"
      responses:
        "200":
          description: Funnel report
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FunnelReport"
              example:
                group_by: "stage"
                data:
                  - stage_id: "stage_prospect"
                    count: 52
                    total_value: 1240000
  /reports/win-rate:
    get:
      summary: Win rate report
      parameters:
        - $ref: "#/components/parameters/ReportFrom"
        - $ref: "#/components/parameters/ReportTo"
        - $ref: "#/components/parameters/ReportGroupBy"
      responses:
        "200":
          description: Win rate report
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WinRateReport"
  /reports/forecast:
    get:
      summary: Forecast report (weighted)
      parameters:
        - $ref: "#/components/parameters/ReportFrom"
        - $ref: "#/components/parameters/ReportTo"
        - $ref: "#/components/parameters/ReportGroupBy"
      responses:
        "200":
          description: Forecast report
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ForecastReport"
              example:
                group_by: "owner"
                data:
                  - owner_id: "user_02"
                    weighted_value: 560000
  /reports/activity-counts:
    get:
      summary: Activity counts report
      parameters:
        - $ref: "#/components/parameters/ReportFrom"
        - $ref: "#/components/parameters/ReportTo"
        - $ref: "#/components/parameters/ReportGroupBy"
      responses:
        "200":
          description: Activity counts
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ActivityCountsReport"
  /webhooks:
    get:
      summary: List webhooks
      responses:
        "200":
          description: Webhooks list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginatedWebhooks"
    post:
      summary: Create webhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WebhookCreate"
      responses:
        "201":
          description: Created webhook
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Webhook"
  /webhooks/{webhook_id}:
    parameters:
      - $ref: "#/components/parameters/WebhookId"
    delete:
      summary: Delete webhook
      responses:
        "204":
          description: Deleted
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  headers:
    ETag:
      schema:
        type: string
      description: Entity tag for optimistic locking
    RateLimitLimit:
      schema:
        type: integer
      description: Request limit per window
    RateLimitRemaining:
      schema:
        type: integer
      description: Remaining requests in window
    RateLimitReset:
      schema:
        type: integer
      description: Unix timestamp for reset
  parameters:
    Cursor:
      name: cursor
      in: query
      schema:
        type: string
      description: Cursor for pagination
    Limit:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 50
    StageLimit:
      name: stage_limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 25
      description: Items per stage for kanban
    StageCursor:
      name: stage_cursor
      in: query
      schema:
        type: string
      description: Cursor token per stage (JSON encoded map of stage_id to cursor)
    Sort:
      name: sort
      in: query
      schema:
        type: string
      description: Sort expression, e.g. "updated_at:desc"
    IfMatch:
      name: If-Match
      in: header
      schema:
        type: string
      description: ETag to enforce optimistic locking
    PipelineId:
      name: pipeline_id
      in: path
      required: true
      schema:
        type: string
    StageId:
      name: stage_id
      in: path
      required: true
      schema:
        type: string
    DealId:
      name: deal_id
      in: path
      required: true
      schema:
        type: string
    ContactId:
      name: contact_id
      in: path
      required: true
      schema:
        type: string
    OrganizationId:
      name: organization_id
      in: path
      required: true
      schema:
        type: string
    ActivityId:
      name: activity_id
      in: path
      required: true
      schema:
        type: string
    NoteId:
      name: note_id
      in: path
      required: true
      schema:
        type: string
    FileId:
      name: file_id
      in: path
      required: true
      schema:
        type: string
    UserId:
      name: user_id
      in: path
      required: true
      schema:
        type: string
    WebhookId:
      name: webhook_id
      in: path
      required: true
      schema:
        type: string
    DealFilterStage:
      name: stage_id
      in: query
      schema:
        type: string
      description: Filter by stage
    DealFilterOwner:
      name: owner_id
      in: query
      schema:
        type: string
      description: Filter by owner
    DealFilterLabel:
      name: label
      in: query
      schema:
        type: string
      description: Filter by label
    DealFilterStatus:
      name: status
      in: query
      schema:
        $ref: "#/components/schemas/DealStatus"
    DealFilterValueMin:
      name: value_min
      in: query
      schema:
        type: number
      description: Filter by minimum value
    DealFilterValueMax:
      name: value_max
      in: query
      schema:
        type: number
      description: Filter by maximum value
    DealFilterUpdatedFrom:
      name: updated_from
      in: query
      schema:
        type: string
        format: date-time
    DealFilterUpdatedTo:
      name: updated_to
      in: query
      schema:
        type: string
        format: date-time
    DealFilterNextActivityFrom:
      name: next_activity_from
      in: query
      schema:
        type: string
        format: date-time
    DealFilterNextActivityTo:
      name: next_activity_to
      in: query
      schema:
        type: string
        format: date-time
    ReportFrom:
      name: from
      in: query
      schema:
        type: string
        format: date
    ReportTo:
      name: to
      in: query
      schema:
        type: string
        format: date
    ReportGroupBy:
      name: group_by
      in: query
      schema:
        type: string
        enum: [owner, stage, label]
  responses:
    BadRequest:
      description: Bad request
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Problem"
    Unauthorized:
      description: Unauthorized
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Problem"
    NotFound:
      description: Not found
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Problem"
    Conflict:
      description: Conflict
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/Problem"
  schemas:
    Problem:
      type: object
      required: [type, title, status, detail, code]
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        code:
          type: string
        instance:
          type: string
          format: uri
    AuthTokens:
      type: object
      required: [access_token, refresh_token, token_type, expires_in]
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        token_type:
          type: string
        expires_in:
          type: integer
    BaseEntity:
      type: object
      required: [id, created_at, updated_at]
      properties:
        id:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        deleted_at:
          type: string
          format: date-time
          nullable: true
    User:
      allOf:
        - $ref: "#/components/schemas/BaseEntity"
        - type: object
          required: [email, name, role]
          properties:
            email:
              type: string
              format: email
            name:
              type: string
            role:
              $ref: "#/components/schemas/UserRole"
    UserCreate:
      type: object
      required: [email, name, role]
      properties:
        email:
          type: string
          format: email
        name:
          type: string
        role:
          $ref: "#/components/schemas/UserRole"
    UserUpdate:
      type: object
      properties:
        name:
          type: string
        role:
          $ref: "#/components/schemas/UserRole"
    UserRole:
      type: string
      enum: [admin, manager, rep]
    Pipeline:
      allOf:
        - $ref: "#/components/schemas/BaseEntity"
        - type: object
          required: [name]
          properties:
            name:
              type: string
            is_default:
              type: boolean
              default: false
    PipelineCreate:
      type: object
      required: [name]
      properties:
        name:
          type: string
        is_default:
          type: boolean
    PipelineUpdate:
      type: object
      properties:
        name:
          type: string
        is_default:
          type: boolean
    Stage:
      allOf:
        - $ref: "#/components/schemas/BaseEntity"
        - type: object
          required: [name, pipeline_id, order]
          properties:
            name:
              type: string
            pipeline_id:
              type: string
            order:
              type: integer
            win_probability:
              type: number
              minimum: 0
              maximum: 1
    StageCreate:
      type: object
      required: [name, pipeline_id, order]
      properties:
        name:
          type: string
        pipeline_id:
          type: string
        order:
          type: integer
        win_probability:
          type: number
    StageUpdate:
      type: object
      properties:
        name:
          type: string
        order:
          type: integer
        win_probability:
          type: number
    Deal:
      allOf:
        - $ref: "#/components/schemas/BaseEntity"
        - type: object
          required: [title, value, status, stage_id, pipeline_id, owner_id]
          properties:
            title:
              type: string
            value:
              $ref: "#/components/schemas/Money"
            status:
              $ref: "#/components/schemas/DealStatus"
            stage_id:
              type: string
            pipeline_id:
              type: string
            owner_id:
              type: string
            organization_id:
              type: string
              nullable: true
            contact_id:
              type: string
              nullable: true
            priority:
              $ref: "#/components/schemas/DealPriority"
            labels:
              type: array
              items:
                type: string
            next_activity:
              $ref: "#/components/schemas/DealNextActivity"
            last_updated_by:
              type: string
    DealCreate:
      type: object
      required: [title, value, pipeline_id, stage_id, owner_id]
      properties:
        title:
          type: string
        value:
          $ref: "#/components/schemas/Money"
        pipeline_id:
          type: string
        stage_id:
          type: string
        organization_id:
          type: string
        contact_id:
          type: string
        owner_id:
          type: string
        priority:
          $ref: "#/components/schemas/DealPriority"
        labels:
          type: array
          items:
            type: string
    DealUpdate:
      type: object
      properties:
        title:
          type: string
        value:
          $ref: "#/components/schemas/Money"
        stage_id:
          type: string
        owner_id:
          type: string
        priority:
          $ref: "#/components/schemas/DealPriority"
        status:
          $ref: "#/components/schemas/DealStatus"
        labels:
          type: array
          items:
            type: string
        next_activity:
          $ref: "#/components/schemas/DealNextActivity"
    DealMove:
      type: object
      required: [to_stage_id]
      properties:
        to_stage_id:
          type: string
        position:
          type: integer
          minimum: 0
    DealBulkUpdate:
      type: object
      required: [deal_ids, update]
      properties:
        deal_ids:
          type: array
          items:
            type: string
        update:
          type: object
          properties:
            stage_id:
              type: string
            owner_id:
              type: string
            status:
              $ref: "#/components/schemas/DealStatus"
            labels:
              type: array
              items:
                type: string
    DealStatus:
      type: string
      enum: [open, won, lost]
    DealPriority:
      type: string
      enum: [low, medium, high, urgent]
    DealNextActivity:
      type: object
      properties:
        due_at:
          type: string
          format: date-time
        type:
          $ref: "#/components/schemas/ActivityType"
    Money:
      type: object
      required: [amount, currency]
      properties:
        amount:
          type: number
        currency:
          type: string
          description: ISO 4217 currency code
    Contact:
      allOf:
        - $ref: "#/components/schemas/BaseEntity"
        - type: object
          required: [name]
          properties:
            name:
              type: string
            email:
              type: string
              format: email
            phone:
              type: string
            organization_id:
              type: string
              nullable: true
    ContactCreate:
      type: object
      required: [name]
      properties:
        name:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        organization_id:
          type: string
    ContactUpdate:
      type: object
      properties:
        name:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        organization_id:
          type: string
    Organization:
      allOf:
        - $ref: "#/components/schemas/BaseEntity"
        - type: object
          required: [name]
          properties:
            name:
              type: string
            domain:
              type: string
            industry:
              type: string
            owner_id:
              type: string
    OrganizationCreate:
      type: object
      required: [name]
      properties:
        name:
          type: string
        domain:
          type: string
        industry:
          type: string
        owner_id:
          type: string
    OrganizationUpdate:
      type: object
      properties:
        name:
          type: string
        domain:
          type: string
        industry:
          type: string
        owner_id:
          type: string
    Activity:
      allOf:
        - $ref: "#/components/schemas/BaseEntity"
        - type: object
          required: [type, subject, due_at, status, owner_id]
          properties:
            deal_id:
              type: string
              nullable: true
            contact_id:
              type: string
              nullable: true
            type:
              $ref: "#/components/schemas/ActivityType"
            subject:
              type: string
            due_at:
              type: string
              format: date-time
            status:
              $ref: "#/components/schemas/ActivityStatus"
            owner_id:
              type: string
    ActivityCreate:
      type: object
      required: [type, subject, due_at, owner_id]
      properties:
        deal_id:
          type: string
        contact_id:
          type: string
        type:
          $ref: "#/components/schemas/ActivityType"
        subject:
          type: string
        due_at:
          type: string
          format: date-time
        owner_id:
          type: string
    ActivityUpdate:
      type: object
      properties:
        type:
          $ref: "#/components/schemas/ActivityType"
        subject:
          type: string
        due_at:
          type: string
          format: date-time
        status:
          $ref: "#/components/schemas/ActivityStatus"
    ActivityType:
      type: string
      enum: [call, meeting, email, task]
    ActivityStatus:
      type: string
      enum: [planned, completed, canceled]
    Note:
      allOf:
        - $ref: "#/components/schemas/BaseEntity"
        - type: object
          required: [body]
          properties:
            deal_id:
              type: string
              nullable: true
            body:
              type: string
            created_by:
              type: string
    NoteCreate:
      type: object
      required: [body]
      properties:
        deal_id:
          type: string
        body:
          type: string
        created_by:
          type: string
    NoteUpdate:
      type: object
      properties:
        body:
          type: string
    File:
      allOf:
        - $ref: "#/components/schemas/BaseEntity"
        - type: object
          required: [file_name, content_type, size_bytes]
          properties:
            deal_id:
              type: string
              nullable: true
            note_id:
              type: string
              nullable: true
            file_name:
              type: string
            content_type:
              type: string
            size_bytes:
              type: integer
            storage_key:
              type: string
    FileUploadInit:
      type: object
      required: [file_name, content_type, size_bytes]
      properties:
        deal_id:
          type: string
        note_id:
          type: string
        file_name:
          type: string
        content_type:
          type: string
        size_bytes:
          type: integer
    FileUploadInitResponse:
      type: object
      required: [upload_url, file]
      properties:
        upload_url:
          type: string
          format: uri
        headers:
          type: object
          additionalProperties:
            type: string
        file:
          $ref: "#/components/schemas/File"
    FileDownload:
      type: object
      required: [download_url]
      properties:
        download_url:
          type: string
          format: uri
        expires_at:
          type: string
          format: date-time
    Webhook:
      allOf:
        - $ref: "#/components/schemas/BaseEntity"
        - type: object
          required: [url, events]
          properties:
            url:
              type: string
              format: uri
            events:
              type: array
              items:
                $ref: "#/components/schemas/WebhookEvent"
            secret:
              type: string
              description: Used for signature verification
    WebhookCreate:
      type: object
      required: [url, events]
      properties:
        url:
          type: string
          format: uri
        events:
          type: array
          items:
            $ref: "#/components/schemas/WebhookEvent"
    WebhookEvent:
      type: string
      enum:
        - deal.created
        - deal.updated
        - deal.moved
        - deal.won
        - deal.lost
        - activity.created
        - activity.completed
        - note.created
        - file.uploaded
    PipelineKanban:
      type: object
      required: [pipeline, stages]
      properties:
        pipeline:
          $ref: "#/components/schemas/Pipeline"
        stages:
          type: array
          items:
            $ref: "#/components/schemas/KanbanStage"
    KanbanStage:
      type: object
      required: [stage, deals, next_cursor]
      properties:
        stage:
          $ref: "#/components/schemas/Stage"
        deals:
          type: array
          items:
            $ref: "#/components/schemas/DealSummary"
        next_cursor:
          type: string
          nullable: true
    DealSummary:
      type: object
      required: [id, title, value, status, owner_id, updated_at]
      properties:
        id:
          type: string
        title:
          type: string
        value:
          $ref: "#/components/schemas/Money"
        status:
          $ref: "#/components/schemas/DealStatus"
        owner_id:
          type: string
        organization_id:
          type: string
        contact_id:
          type: string
        priority:
          $ref: "#/components/schemas/DealPriority"
        labels:
          type: array
          items:
            type: string
        next_activity:
          $ref: "#/components/schemas/DealNextActivity"
        updated_at:
          type: string
          format: date-time
    StagesResponse:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Stage"
    PaginatedPipelines:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Pipeline"
        next_cursor:
          type: string
          nullable: true
    PaginatedDeals:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Deal"
        next_cursor:
          type: string
          nullable: true
        total_count:
          type: integer
    PaginatedContacts:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Contact"
        next_cursor:
          type: string
          nullable: true
    PaginatedOrganizations:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Organization"
        next_cursor:
          type: string
          nullable: true
    PaginatedActivities:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Activity"
        next_cursor:
          type: string
          nullable: true
    PaginatedNotes:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Note"
        next_cursor:
          type: string
          nullable: true
    PaginatedFiles:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/File"
        next_cursor:
          type: string
          nullable: true
    PaginatedUsers:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/User"
        next_cursor:
          type: string
          nullable: true
    PaginatedWebhooks:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Webhook"
        next_cursor:
          type: string
          nullable: true
    BulkResult:
      type: object
      required: [updated, failed]
      properties:
        updated:
          type: array
          items:
            type: string
        failed:
          type: array
          items:
            type: object
            required: [id, code, detail]
            properties:
              id:
                type: string
              code:
                type: string
              detail:
                type: string
    SearchResults:
      type: object
      required: [data]
      properties:
        data:
          type: array
          items:
            oneOf:
              - $ref: "#/components/schemas/Deal"
              - $ref: "#/components/schemas/Contact"
              - $ref: "#/components/schemas/Organization"
        next_cursor:
          type: string
          nullable: true
    FunnelReport:
      type: object
      required: [group_by, data]
      properties:
        group_by:
          type: string
        data:
          type: array
          items:
            type: object
            properties:
              stage_id:
                type: string
              count:
                type: integer
              total_value:
                type: number
    WinRateReport:
      type: object
      required: [group_by, data]
      properties:
        group_by:
          type: string
        data:
          type: array
          items:
            type: object
            properties:
              owner_id:
                type: string
              won:
                type: integer
              lost:
                type: integer
              win_rate:
                type: number
    ForecastReport:
      type: object
      required: [group_by, data]
      properties:
        group_by:
          type: string
        data:
          type: array
          items:
            type: object
            properties:
              owner_id:
                type: string
              weighted_value:
                type: number
    ActivityCountsReport:
      type: object
      required: [group_by, data]
      properties:
        group_by:
          type: string
        data:
          type: array
          items:
            type: object
            properties:
              owner_id:
                type: string
              type:
                type: string
              count:
                type: integer
